---
title: "Data_Analysis_JRME"
author: "Sebastian Robledo"
date: "6/25/2021"
output: html_document
---

# Creating the environment 

```{r}
library(lavaan)
library(here)
library(tidyverse)
library(semTools)
library(stargazer)
library(psych)
library(GPArotation)
library(semPlot)
library(MVN)
library(corrr)
library(performance)
library(tidymodels)
library(moderndive)
library(anomalize)
library(timeSeries)
source(here("scripts", "functions.R"))
```

# Getting data 

```{r}
data_jrme <- 
  read.csv(here("data",
                "jrme_data_all.csv")) |> 
  mutate(Net_Str = constraint_sc)
```

# Try 5

```{r}
data_vivi <- 
  read.csv(here("data", "jrme_data_all_1.csv")) |> 
  select(NET_Q1, NET_Q2, NET_Q3, NET_Q4, constraint)
```


Data transformation

```{r}
data_vivi_tr <- 
  data_vivi |> 
  rowwise() |> 
  mutate(networking_sum = sum(c(NET_Q1, NET_Q2, NET_Q3, NET_Q4)),
         NET_Q1_tr = NET_Q1/networking_sum*10, 
         NET_Q2_tr = NET_Q2/networking_sum*10, 
         NET_Q3_tr = NET_Q3/networking_sum*10,
         NET_Q4_tr = NET_Q4/networking_sum*10) |> 
  mutate(NET_Q1_log = log10(NET_Q1_tr), 
         NET_Q2_log = log10(NET_Q2_tr), 
         NET_Q3_log = log10(NET_Q3_tr),
         NET_Q4_log = log10(NET_Q4_tr))

data_vivi_center <- 
  center_colmeans(data_vivi_tr |> 
                    select(NET_Q1_log, 
                           NET_Q2_log, 
                           NET_Q3_log , 
                           NET_Q4_log)) 

data_vivi_autscale <- 
  center_colstd.dev(data_vivi_center)

  mutate(NET_Q1_log = center_colmeans(c(NET_Q1_tr, NET_Q2_tr))), 
         NET_Q2_log = center_colmeans(NET_Q2_tr), 
         NET_Q3_log = center_colmeans(NET_Q3_tr),
         NET_Q4_log = center_colmeans(NET_Q4_tr))
  
```


# Try 4

```{r}
data_jrme_mod_4 <- 
  semTools::indProd(data_tidied_1,
                    var1 = c("NET_Q1_tr", "NET_Q2_tr", "NET_Q3_tr", "NET_Q4_tr"),
                    var2 = c("ME_Q1_tr","ME_Q2_tr", "ME_Q3_tr", "ME_Q4_tr"),
                    match = FALSE,
                    meanC = TRUE,
                    residualC = FALSE,
                    doubleMC = TRUE)
```

```{r}
data_jrme_mod_4 |>
  select(60:75) |> 
  names()
```


Model

```{r}
networking_model_mod_4 <- 
  "# measurement model
   networking_jrme =~ NET_Q1_tr + NET_Q2_tr + NET_Q3_tr + NET_Q4_tr
   effectuation <~ ME_Q1_tr + ME_Q2_tr + ME_Q3_tr + ME_Q4_tr
   net_structure =~ constraint
   # interaction term
   networkingeffectuation =~  NET_Q1_tr.ME_Q1_tr + NET_Q1_tr.ME_Q2_tr + NET_Q1_tr.ME_Q3_tr + NET_Q1_tr.ME_Q4_tr +
                              NET_Q2_tr.ME_Q1_tr + NET_Q2_tr.ME_Q2_tr + NET_Q2_tr.ME_Q3_tr + NET_Q2_tr.ME_Q4_tr +
                              NET_Q3_tr.ME_Q1_tr + NET_Q3_tr.ME_Q2_tr + NET_Q3_tr.ME_Q3_tr + NET_Q3_tr.ME_Q4_tr +
                              NET_Q4_tr.ME_Q1_tr + NET_Q4_tr.ME_Q2_tr + NET_Q4_tr.ME_Q3_tr + NET_Q4_tr.ME_Q4_tr
   # regressions
   net_structure ~ networking_jrme + networkingeffectuation
   # residual correlations"
```


Model fit 

```{r}
networking_fit_mod_4 <- 
  sem(model = networking_model_mod_4, 
      data = data_jrme_mod_4)
```

Table 

```{r}
parameterestimates(networking_fit_mod_4,
                   standardized = TRUE) |> 
  filter(op == "~") |> 
  mutate(stars = ifelse(pvalue < 0.001, "***",
                        ifelse(pvalue < 0.01, "**",
                               ifelse(pvalue < 0.05, "*", "")))) |> 
  select(LHS = lhs, RHS = rhs, Coefficient = est, 
         Z = z, "p-value" = pvalue, Sig. = stars) |> 
  stargazer(type = "text", title = "Regression Coefficients", 
            summary = FALSE, digits = 3, 
            digits.extra = 0, rownames = FALSE)
```

The model's outputs are poor. We need to improve the relationship between networking and net_structure. I want to see the correlations. 

```{r}
data_tidied_1 |> 
  rowwise() |> 
  mutate(networking_mean_raw = mean(c(NET_Q1, NET_Q2, NET_Q3, NET_Q4))) |> 
  select(networking_mean, networking_mean_raw, constraint, density, clustering) 
```

What if we remove items?. For example, items with 0 standard deviation?

```{r}
data_tidied_2 <- 
  data_tidied_1 |> 
  rowwise() |> 
  mutate(networking_sd = sd(c(NET_Q1, NET_Q2, NET_Q3, NET_Q4)),
         effectuation_sd = sd(c(ME_Q1, ME_Q2, ME_Q3, ME_Q4))) |> 
  filter(networking_sd == 0) |> 
  filter(effectuation_sd == 0)
```

```{r}
data_tidied_2 |> 
  rowwise() |> 
  mutate(networking_mean_raw = mean(c(NET_Q1, NET_Q2, NET_Q3, NET_Q4))) |> 
  select(networking_mean, networking_mean_raw, constraint, density, clustering) |> 
  correlate()
```

Checking the regression model 

```{r}
df_1 <- 
  data_tidied_1 |> 
  rowwise() |> 
  mutate(networking_mean_raw = mean(c(NET_Q1, NET_Q2, NET_Q3, NET_Q4))) |>
  select(networking_mean, constraint)

model_1 <- 
  linear_reg() |> 
  set_engine("lm") |> 
  fit(constraint ~ networking_mean, df_1)

model_2 <- lm(constraint ~ networking_mean, df_1)

get_regression_table(model_2)
```
Checking the model

```{r}
performance::check_model(model_2)
```
```{r}
df_1 |> 
  mutate(ET_Q1_sc_tr = autoTransform(NET_Q1),
         NET_Q2_sc_tr = autoTransform(NET_Q2),
         NET_Q3_sc_tr = autoTransform(NET_Q3),
         NET_Q4_sc_tr = autoTransform(NET_Q4)) |> 
  select(networking_mean, constraint) |>
  pivot_longer(cols = c(networking_mean, 
                        constraint), 
               names_to = "variable", 
               values_to =  "value") |> 
  ggplot(aes(x = variable, y = value)) +
  geom_boxplot() +
  facet_wrap(~ variable)

```

```{r}
data_tidied_1_csv <- read_csv(here("data", "jrme_data_all_1.csv"))


data_tidied_1_csv |> 
  mutate(NET_Q1_tr_sc = scale(NET_Q1_tr),
         NET_Q2_tr_sc = scale(NET_Q2_tr),
         NET_Q3_tr_sc = scale(NET_Q3_tr),
         NET_Q4_tr_sc = scale(NET_Q4_tr)) |> 
  rowwise() |> 
  mutate(networking_mean_tr_sc = mean(c(NET_Q1_tr_sc, 
                                        NET_Q2_tr_sc, 
                                        NET_Q3_tr_sc, 
                                        NET_Q4_tr_sc))) |>
  select(networking_mean_tr_sc, constraint) |> 
  pivot_longer(cols = c(networking_mean_tr_sc, 
                        constraint), 
               names_to = "variable", 
               values_to =  "value") |> 
  ggplot(aes(x = variable, y = value)) +
  geom_boxplot() +
  facet_wrap(~ variable)
```

```{r}
data_tidied_1_csv |> 
  mutate(NET_Q1_tr_sc = scale(NET_Q1_tr),
         NET_Q2_tr_sc = scale(NET_Q2_tr),
         NET_Q3_tr_sc = scale(NET_Q3_tr),
         NET_Q4_tr_sc = scale(NET_Q4_tr)) |> 
  rowwise() |> 
  mutate(networking_mean_tr_sc = mean(c(NET_Q1_tr_sc, 
                                        NET_Q2_tr_sc, 
                                        NET_Q3_tr_sc, 
                                        NET_Q4_tr_sc))) |>
  select(networking_mean_tr_sc, constraint) |> 
  ggplot(aes(x = networking_mean_tr_sc, y = constraint)) +
  geom_point() +
  geom_smooth()
```
remove outliers....in networking 

```{r}
data_tidied_2 <- 
  data_tidied_1_csv |> 
  mutate(NET_Q1_tr_sc = scale(NET_Q1_tr),
         NET_Q2_tr_sc = scale(NET_Q2_tr),
         NET_Q3_tr_sc = scale(NET_Q3_tr),
         NET_Q4_tr_sc = scale(NET_Q4_tr)) |> 
  rowwise() |> 
  mutate(networking_mean_tr_sc = mean(c(NET_Q1_tr_sc, 
                                        NET_Q2_tr_sc, 
                                        NET_Q3_tr_sc, 
                                        NET_Q4_tr_sc))) 
  
data_tidied_2 |> 
  anomalize(NET_Q1, method = "gesd") |> # just 4 and the rest no-one. 
  filter(anomaly == "No") |> 
  select(-NET_Q1_l1,NET_Q1_l2, -anomaly) |> 
  anomalize(NET_Q4, method = "gesd") |> 
  filter(anomaly == "No") |> 
  select(NET_Q4, anomaly) 
```

Remove extreme values 

http://qsel.columbia.edu/formhub.R/demo/RemoveOutliers.html

```{r}
data_tidied_2 |> 
  ggplot(aes(x = networking_mean_tr_sc)) +
  geom_histogram()
```
```{r}
data_tidied_2 |> 
  ggplot(aes(x = constraint)) +
  geom_histogram()
```
Scale and transform constraint????

# Try 3

```{r}
data_jrme_mod_3 <- 
  semTools::indProd(data_tidied_1,
                    var1 = c("NET_Q1_tr", "NET_Q2_tr", "NET_Q3_tr", "NET_Q4_tr"),
                    var2 = c("ME_Q2_tr", "ME_Q3_tr", "ME_Q4_tr"),
                    match = FALSE,
                    meanC = TRUE,
                    residualC = FALSE,
                    doubleMC = TRUE)
```

Model 

```{r}
networking_model_mod_3 <- 
  "# measurement model
   networking_jrme =~ NET_Q1_tr + NET_Q2_tr + NET_Q3_tr + NET_Q4_tr
   effectuation =~ ME_Q2_tr + ME_Q3_tr + ME_Q4_tr
   net_structure =~ constraint
   # interaction term
   networkingeffectuation =~ NET_Q1_tr.ME_Q2_tr + NET_Q1_tr.ME_Q3_tr + NET_Q1_tr.ME_Q4_tr +
                             NET_Q2_tr.ME_Q2_tr + NET_Q2_tr.ME_Q3_tr + NET_Q2_tr.ME_Q4_tr +
                             NET_Q3_tr.ME_Q2_tr + NET_Q3_tr.ME_Q3_tr + NET_Q3_tr.ME_Q4_tr +
                             NET_Q4_tr.ME_Q2_tr + NET_Q4_tr.ME_Q3_tr + NET_Q4_tr.ME_Q4_tr
   # regressions
   net_structure ~ networking_jrme + effectuation + networkingeffectuation
   # residual correlations"
```


Model fit 

```{r}
networking_fit_mod_3 <- 
  sem(model = networking_model_mod_3, 
      data = data_jrme_mod_3)
```

Table 

```{r}
parameterestimates(networking_fit_mod_3,
                   standardized = TRUE) |> 
  filter(op == "~") |> 
  mutate(stars = ifelse(pvalue < 0.001, "***",
                        ifelse(pvalue < 0.01, "**",
                               ifelse(pvalue < 0.05, "*", "")))) |> 
  select(LHS = lhs, RHS = rhs, Coefficient = est, 
         Z = z, "p-value" = pvalue, Sig. = stars) |> 
  stargazer(type = "text", title = "Regression Coefficients", 
            summary = FALSE, digits = 3, 
            digits.extra = 0, rownames = FALSE)
```


# Try 2

http://www.koreascience.or.kr/article/JAKO201919059190001.view

```{r}
data_jrme_mod <- 
  semTools::indProd(data_tidied_1,
                    var1 = c("NET_Q1", "NET_Q2", "NET_Q3", "NET_Q4"),
                    var2 = c("ME_Q2", "ME_Q3", "ME_Q4"),
                    match = FALSE,
                    meanC = TRUE,
                    residualC = FALSE,
                    doubleMC = TRUE)
```

New variables

```{r}
data_jrme_mod |> 
  select(48:59) |> 
  names()
```

Model 

```{r}
networking_model_mod <- 
  "# measurement model
   networking_jrme =~ NET_Q1 + NET_Q2 + NET_Q3 + NET_Q4
   effectuation =~ ME_Q2 + ME_Q3 + ME_Q4
   net_structure =~ constraint
   # interaction term
   networkingeffectuation =~ NET_Q1.ME_Q2 + NET_Q1.ME_Q3 + NET_Q1.ME_Q4 +
                             NET_Q2.ME_Q2 + NET_Q2.ME_Q3 + NET_Q2.ME_Q4 +
                             NET_Q3.ME_Q2 + NET_Q3.ME_Q3 + NET_Q3.ME_Q4 +
                             NET_Q4.ME_Q2 + NET_Q4.ME_Q3 + NET_Q4.ME_Q4
   # regressions
   net_structure ~ networking_jrme + effectuation + networkingeffectuation
   # residual correlations"
```

Model fit 

```{r}
networking_fit_mod <- 
  sem(model = networking_model_mod, 
      data = data_jrme_mod)
```


```{r}
summary(networking_fit_mod, standardized = TRUE)
```


```{r}
parameterestimates(networking_fit_mod, standardized = TRUE)
```
```{r}
parameterestimates(networking_fit_mod, standardized = TRUE) |> 
  filter(op == "~") |> 
  mutate(stars = ifelse(pvalue < 0.001, "***",
                        ifelse(pvalue < 0.01, "**",
                               ifelse(pvalue < 0.05, "*", "")))) |> 
  select(LHS = lhs, RHS = rhs, Coefficient = est, 
         Z = z, "p-value" = pvalue, Sig. = stars) |> 
  stargazer(type = "text", title = "Regression Coefficients", 
            summary = FALSE, digits = 3, 
            digits.extra = 0, rownames = FALSE)
```


# Try 1

## Moderating effect

Creating the interaction term between networking and effectuation

```{r}
data_jrme_modet <- 
  data_jrme |> 
  mutate(networking_x_effectuation = networking * modelo_efectual)
```

Parameters

```{r}
moderation_model <- "
  # regressions
  Net_Str ~ b1*networking
  Net_Str ~ b2*modelo_efectual
  Net_Str ~ b3*networking_x_effectuation
  
  modelo_efectual ~ modelo_efectual.mean*1
  
  modelo_efectual ~~ modelo_efectual.var*modelo_efectual
  
  SD.below := b1 + b3*(modelo_efectual.mean - sqrt(modelo_efectual))
  mean := b1 + b3*(modelo_efectual)
  SD.above := b1 + b3*(modelo_efectual.mean + sqrt(modelo_efectual))
  "


EffecModel_jrme <- "
                    
                    networking ~ modelo_efectual
                    Net_Str ~ networking
                    "
```


```{r}
sem1 <- 
  cfa(EffecModel_jrme, data = data_jrme_modet)
```

```{r}
summary(sem1, fit.measures=TRUE, standardized=T,rsquare=T)
```

