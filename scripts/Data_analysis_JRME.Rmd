---
title: "Data_Analysis_JRME"
author: "Sebastian Robledo"
date: "6/25/2021"
output: html_document
---

# Creating the environment 

```{r}
library(lavaan)
library(here)
library(tidyverse)
library(semTools)
library(stargazer)
library(psych)
library(GPArotation)
library(semPlot)
library(MVN)
library(corrr)
library(performance)
library(tidymodels)
library(moderndive)
library(anomalize)
library(timeSeries)
library(bestNormalize)
library(gridExtra)
library(psych)
library(semPLS)
library(gt)
library(parameters)
source(here("scripts", "functions.R"))
```

# Getting data 

```{r}
data_jrme <- 
  read.csv(here("data",
                "jrme_data_all.csv")) |> 
  mutate(Net_Str = constraint_sc)
```

# Try 8 

We're gonna change the model... this is a different option of the reviewers but the model will fit the values. 


```{r}
data_vivi_autscale_total_8 <- 
  data_raw_5 |> 
  left_join(df_egonet |> 
              dplyr::select(email, density)) |> 
  rowwise() |> 
  mutate(networking_sum = sum(c(NET_Q1, NET_Q2, NET_Q3, NET_Q4)), # NETWORKING
         NET_Q1_tr = NET_Q1/networking_sum*10, 
         NET_Q2_tr = NET_Q2/networking_sum*10, 
         NET_Q3_tr = NET_Q3/networking_sum*10,
         NET_Q4_tr = NET_Q4/networking_sum*10) |> 
  mutate(NET_Q1_log = log10(NET_Q1_tr), 
         NET_Q2_log = log10(NET_Q2_tr), 
         NET_Q3_log = log10(NET_Q3_tr),
         NET_Q4_log = log10(NET_Q4_tr)) |> 
  mutate(effectuation_sum = sum(c(ME_Q1, ME_Q2, ME_Q3, ME_Q4)), # EFFECTUATION
         ME_Q1_tr = ME_Q1/effectuation_sum*10, 
         ME_Q2_tr = ME_Q2/effectuation_sum*10, 
         ME_Q3_tr = ME_Q3/effectuation_sum*10,
         ME_Q4_tr = ME_Q4/effectuation_sum*10) |> 
  mutate(ME_Q1_log = log10(ME_Q1_tr), 
         ME_Q2_log = log10(ME_Q2_tr), 
         ME_Q3_log = log10(ME_Q3_tr),
         ME_Q4_log = log10(ME_Q4_tr)) |> 
  mutate(WOM_sum = sum(c(WOM_Q1, WOM_Q2, WOM_Q3)),  # WOM
         WOM_Q1_tr = WOM_Q1/WOM_sum*10, 
         WOM_Q2_tr = WOM_Q2/WOM_sum*10, 
         WOM_Q3_tr = WOM_Q3/WOM_sum*10) |> 
  mutate(WOM_Q1_log = log10(WOM_Q1_tr), 
         WOM_Q2_log = log10(WOM_Q2_tr), 
         WOM_Q3_log = log10(WOM_Q3_tr)) 

data_vivi_center_networking_8 <-     # NETWORKING
  center_colmeans(data_vivi_autscale_total_8 |> 
                    select(NET_Q1_log, 
                           NET_Q2_log, 
                           NET_Q3_log , 
                           NET_Q4_log))  |> 
  rename("NET_Q1_trans" = NET_Q1_log,
         "NET_Q2_trans" = NET_Q2_log,
         "NET_Q3_trans" = NET_Q3_log,
         "NET_Q4_trans" = NET_Q4_log)

data_vivi_autscale_networking_8 <- 
  center_colstd.dev(data_vivi_center_networking_8)

data_vivi_center_effectuation_8 <-   # EFFECTUTION
  center_colmeans(data_vivi_autscale_total_8 |> 
                    select(ME_Q1_log, 
                           ME_Q2_log, 
                           ME_Q3_log , 
                           ME_Q4_log)) 

data_vivi_autscale_effectuation_8 <- 
  center_colstd.dev(data_vivi_center_effectuation_8) |> 
  rename("ME_Q1_trans" = ME_Q1_log,
         "ME_Q2_trans" = ME_Q2_log,
         "ME_Q3_trans" = ME_Q3_log,
         "ME_Q4_trans" = ME_Q4_log)

data_vivi_center_WOM_8 <-   # WOM
  center_colmeans(data_vivi_autscale_total_8 |> 
                    select(WOM_Q1_log, 
                           WOM_Q2_log, 
                           WOM_Q3_log )) 

data_vivi_autscale_WOM_8 <- 
  center_colstd.dev(data_vivi_center_WOM_8) |> 
  rename("WOM_Q1_trans" = WOM_Q1_log,
         "WOM_Q2_trans" = WOM_Q2_log,
         "WOM_Q3_trans" = WOM_Q3_log)

data_vivi_autscale_total_8_1 <- 
  data_vivi_autscale_total_8 |> 
  bind_cols(data_vivi_autscale_networking_8,
            data_vivi_autscale_effectuation_8,
            data_vivi_autscale_WOM_8) |> 
  rowwise() |> 
  mutate(networking = mean(NET_Q1_log, 
                           NET_Q2_log, 
                           NET_Q3_log , 
                           NET_Q4_log),
         effectuation = mean(ME_Q1_log, 
                             ME_Q2_log, 
                             ME_Q3_log , 
                             ME_Q4_log),
         word_of_mouth = mean(WOM_Q1_log, 
                              WOM_Q1_log, 
                              WOM_Q3_log))

data_vivi_autscale_total_8_outliers <- 
  data_vivi_autscale_total_8_1 |>
  rowwise() |> 
  anomalize(networking, method = "gesd") |> 
  dplyr::filter(anomaly != "Yes") |> 
  select(-networking_l1, -networking_l2, -anomaly) |> 
  anomalize(effectuation, method = "gesd") |> 
  dplyr::filter(anomaly != "Yes") |> 
  select(-effectuation_l1, -effectuation_l2, -anomaly) |> 
  anomalize(word_of_mouth, method = "gesd") |> 
  dplyr::filter(anomaly != "Yes") |> 
  select(-word_of_mouth_l1, -word_of_mouth_l2, -anomaly)
```

Moderated effect 

```{r}
data_vivi_autscale_total_8_outliers_mod_effect <- 
  semTools::indProd(data_vivi_autscale_total_8_outliers,
                    var1 = c("NET_Q1", "NET_Q2", "NET_Q3", "NET_Q4"),
                    var2 = c("ME_Q2", "ME_Q3", "ME_Q4"),
                    match = FALSE,
                    meanC = TRUE,
                    residualC = FALSE,
                    doubleMC = TRUE)
```


Model

```{r}
Model_8 <- "# Measurement model
            Networking =~ NET_Q1 + NET_Q2 + NET_Q4
            WOM   =~ WOM_Q1 + WOM_Q2 + WOM_Q3
            Effectuation =~ ME_Q2 + ME_Q3 + ME_Q4
            # Moderate effect
            networkingeffectuation =~ NET_Q1.ME_Q2 + NET_Q1.ME_Q3 + NET_Q1.ME_Q4 +
                                      NET_Q2.ME_Q2 + NET_Q2.ME_Q3 + NET_Q2.ME_Q4 +
                                      NET_Q3.ME_Q2 + NET_Q3.ME_Q3 + NET_Q3.ME_Q4 +
                                      NET_Q4.ME_Q2 + NET_Q4.ME_Q3 + NET_Q4.ME_Q4
            Net_Str =~ density
            # Regressions
            Net_Str ~ Networking 
            WOM ~ Networking + Effectuation + networkingeffectuation
            # Residual Correlations
            ME_Q2 ~~ WOM_Q1
            ME_Q3 ~~ WOM_Q2
            ME_Q4 ~~ WOM_Q3"

```

```{r}
model_8_fit <- 
  lavaan::cfa(Model_8, 
              data = data_vivi_autscale_total_8_outliers_mod_effect)
```

Inspecting the factor loading for each item

```{r}
inspect(model_8_fit, what = "std")$lambda
```

Visualizing the results

```{r}
summary(model_8_fit, fit.measures = TRUE, standardized = TRUE, rsquare = TRUE)
```

```{r}
fitMeasures(model_8_fit)
```

```{r}
semTools::reliability(model_8_fit)
```

```{r}
modificationindices(model_8_fit, sort. = TRUE)
```

Table 

```{r}
parameterestimates(model_8_fit,
                   standardized = TRUE) |> 
  filter(op == "~") |> 
  mutate(stars = ifelse(pvalue < 0.001, "***",
                        ifelse(pvalue < 0.01, "**",
                               ifelse(pvalue < 0.05, "*", "")))) |> 
  select(LHS = lhs, RHS = rhs, Coefficient = est, 
         Z = z, "p-value" = pvalue, Sig. = stars) |> 
  stargazer(type = "text", title = "Regression Coefficients", 
            summary = FALSE, digits = 3, 
            digits.extra = 0, rownames = FALSE)
```




# Try 7

```{r}
data_vivi <- 
  read.csv(here("data", "jrme_data_all_1.csv")) |> 
  select(NET_Q1, NET_Q2, NET_Q3, NET_Q4, ME_Q1, ME_Q2, ME_Q3, ME_Q4, 
         constraint, clustering, density)
```

```{r}
data_vivi_autscale_total_7 <- 
  data_vivi_autscale_total_6 |> 
  bind_cols(df_egonet |> select(edges)) |> 
  rowwise() |> 
  mutate(social_network_sum = sum(constraint, density, edges),
         constraint_tr = constraint/social_network_sum,
         edges_tr = edges/social_network_sum,
         density_tr = density/social_network_sum) |> 
  mutate(constraint_log = log10(constraint_tr),
         density_log = log10(density_tr),
         edges_tr_sqrt = sqrt(edges_tr))

data_vivi_center_social_network_7 <- 
  center_colmeans(data_vivi_autscale_total_7 |> 
                    select(constraint_log, 
                           density_log, 
                           edges_tr_sqrt)) 

data_vivi_autscale_social_network_7 <- 
  center_colstd.dev(data_vivi_center_social_network_7) |> 
  rename("constraint_log_1" = constraint_log, 
         "density_log_1" = density_log,
         "edges_tr_sqrt_1" = edges_tr_sqrt)

data_vivi_autscale_total_7_1 <- 
  data_vivi_autscale_total_7 |> 
  bind_cols(data_vivi_autscale_social_network_7) |> 
  rowwise() |> 
  mutate(social_network = mean(constraint_log_1, 
                               density_log_1,
                               edges_tr_sqrt_1),
         networking = mean(NET_Q1_log,
                           NET_Q2_log,
                           NET_Q3_log,
                           NET_Q4_log))

data_vivi_autscale_total_7_outliers <- 
  data_vivi_autscale_total_7_1 |>
  dplyr::filter(edges != 15) |> 
  rowwise() |> 
  anomalize(networking, method = "gesd") |> 
  dplyr::filter(anomaly != "Yes") |> 
  select(-networking_l1, -networking_l2, -anomaly) |> 
  anomalize(social_network, method = "gesd") |> 
  dplyr::filter(anomaly != "Yes")
```

Model

```{r}
model_sem_data_7 <- 
  matrix(c(
    "NET", "NET_Q1_log", 
    "NET", "NET_Q2_log", 
    #"NET", "NET_Q3_log", 
    #"NET", "NET_Q4_log",
    "ER", "constraint_log_1",
    "ER", "density_log_1"
    #"ER", "edges_tr_sqrt_1"
    # "ER", "clustering"
  ),
  ncol = 2, byrow = TRUE
  )

model_pls_7 <- 
  matrix(c(
    "NET", "ER"),
    ncol = 2, byrow = TRUE
  )


PLS_model_7 <- 
  plsm(data = as.data.frame(data_vivi_autscale_total_7_outliers), 
       strucmod = model_pls_7, 
       measuremod = model_sem_data_7)

```

```{r}
PLS_fit_7 <- 
  sempls(model = PLS_model_7, 
         data = as.data.frame(data_vivi_autscale_total_7_outliers))
```

```{r}
plsLoadings(PLS_fit_7) 
```

```{r}
pathCoeff(PLS_fit_7)
```


```{r}
rSquared(PLS_fit_7)
```

#Try 6 

data

```{r}
data_vivi <- 
  read.csv(here("data", "jrme_data_all_1.csv")) |> 
  select(NET_Q1, NET_Q2, NET_Q3, NET_Q4, ME_Q1, ME_Q2, ME_Q3, ME_Q4, 
         constraint, clustering, density)
```


```{r}
data_vivi_tr_6 <- 
  data_vivi |> 
  rowwise() |> 
  mutate(networking_sum = sum(c(NET_Q1, NET_Q2, NET_Q3, NET_Q4)),
         NET_Q1_tr = NET_Q1/networking_sum*10, 
         NET_Q2_tr = NET_Q2/networking_sum*10, 
         NET_Q3_tr = NET_Q3/networking_sum*10,
         NET_Q4_tr = NET_Q4/networking_sum*10) |> 
  mutate(NET_Q1_log = log10(NET_Q1_tr), 
         NET_Q2_log = log10(NET_Q2_tr), 
         NET_Q3_log = log10(NET_Q3_tr),
         NET_Q4_log = log10(NET_Q4_tr)) |> 
  mutate(effectuation_sum = sum(c(ME_Q1, ME_Q2, ME_Q3, ME_Q4)),
         ME_Q1_tr = ME_Q1/effectuation_sum*10, 
         ME_Q2_tr = ME_Q2/effectuation_sum*10, 
         ME_Q3_tr = ME_Q3/effectuation_sum*10,
         ME_Q4_tr = ME_Q4/effectuation_sum*10) |> 
  mutate(ME_Q1_log = log10(ME_Q1_tr), 
         ME_Q2_log = log10(ME_Q2_tr), 
         ME_Q3_log = log10(ME_Q3_tr),
         ME_Q4_log = log10(ME_Q4_tr)) |> 
  mutate(social_network_sum = sum(constraint, clustering, density),
         constraint_tr = constraint/social_network_sum,
         clustering_tr = clustering/social_network_sum,
         density_tr = density/social_network_sum) |> 
  mutate(constraint_log = log10(constraint_tr),
         density_log = log10(density_tr),
         clustering_sqrt = sqrt(clustering_tr))

data_vivi_center_networking_6 <- 
  center_colmeans(data_vivi_tr_6 |> 
                    select(NET_Q1_log, 
                           NET_Q2_log, 
                           NET_Q3_log , 
                           NET_Q4_log)) 

data_vivi_autscale_networking_6 <- 
  center_colstd.dev(data_vivi_center_networking_6)

data_vivi_center_effectuation_6 <- 
  center_colmeans(data_vivi_tr_6 |> 
                    select(ME_Q1_log, 
                           ME_Q2_log, 
                           ME_Q3_log , 
                           ME_Q4_log)) 

data_vivi_autscale_effectuation_6 <- 
  center_colstd.dev(data_vivi_center_effectuation_6)

data_vivi_center_social_network_6 <- 
  center_colmeans(data_vivi_tr_6 |> 
                    select(constraint_log, 
                           density_log, 
                           clustering_sqrt)) 

data_vivi_autscale_social_network_6 <- 
  center_colstd.dev(data_vivi_center_social_network_6)

data_vivi_autscale_total_6 <- 
  data_vivi_autscale_networking_6 |> 
  bind_cols(data_vivi_center_effectuation_6, 
            data_vivi_autscale_social_network_6, 
            data_vivi |> 
              select(NET_Q1, NET_Q2, NET_Q3, NET_Q4, ME_Q1, ME_Q2, ME_Q3, ME_Q4, 
                     constraint, clustering, density))

# constraint_t <- 
#   bestNormalize(data_vivi_autscale_total$constraint)$x.t |> 
#   tibble() |> 
#   rename("constraint_t" = 1) 
# 
# data_vivi_final <- 
#   data_vivi_autscale_total |> 
#   bind_cols(constraint_t)
```


Without outliers 

```{r}
data_vivi_autscale_total_6_outliers <- 
  data_vivi_autscale_total_6 |> 
  rowwise() |> 
  mutate(networking = mean(NET_Q1_log, NET_Q2_log, NET_Q3_log, NET_Q4_log)) |> 
  anomalize(networking, method = "gesd") |> 
  dplyr::filter(anomaly != "Yes") |> 
  select(-networking_l1, -networking_l2, -anomaly) |> 
  mutate(social_network = mean(constraint_log, density_log, clustering_sqrt)) |>
  anomalize(social_network, method = "gesd") |> 
  dplyr::filter(anomaly != "Yes")
```


Model

```{r}
model_sem_data_6 <- 
  matrix(c(
    "NET", "NET_Q1_log", 
    "NET", "NET_Q2_log", 
    "NET", "NET_Q3_log", 
    "NET", "NET_Q4_log",
    # "ER", "constraint_log",
    "ER", "density_log"
    # "ER", "clustering"
  ),
  ncol = 2, byrow = TRUE
  )

model_pls_6 <- 
  matrix(c(
    "NET", "ER"),
    ncol = 2, byrow = TRUE
  )


PLS_model_6 <- 
  plsm(data = as.data.frame(data_vivi_autscale_total_6_outliers), 
       strucmod = model_pls_6, 
       measuremod = model_sem_data_6)

```

```{r}
PLS_fit_6 <- 
  sempls(model = PLS_model_6, 
         data = as.data.frame(data_vivi_autscale_total_6_outliers))
```

```{r}
plsLoadings(PLS_fit_6) 
```

```{r}
pathCoeff(PLS_fit_6)
```

Evaluando el modelo PLS-SEM

Como los modelos de PLS-SEM no evaluan el ajuste del modelo en general, se mostrará dos métodos por los cuales se puede entender su comportamiento.

Revisando los valores de R2

```{r}
rSquared(PLS_fit_6)
```

Haciendo un bootstrapping

```{r}
set.seed(04460)
PLS_boot <- 
  bootsempls(PLS_fit_6, 
             nboot = 500, 
             start = "ones")
```

```{r}
parallelplot(PLS_boot, 
             reflinesAt = 0, 
             alpha = 0.8, 
             varnames = attr(PLS_boot$t, "path")[7], 
             main = "Caminos de coeficientes in 500 PLS bostrap interacciones(N = 112)")
```

# Try 5

```{r}
data_vivi <- 
  read.csv(here("data", "jrme_data_all_1.csv")) |> 
  select(NET_Q1, NET_Q2, NET_Q3, NET_Q4, ME_Q1, ME_Q2, ME_Q3, ME_Q4, 
         constraint, clustering, density)
```


Data transformation

Networking 

```{r}
data_vivi_tr <- 
  data_vivi |> 
  rowwise() |> 
  mutate(networking_sum = sum(c(NET_Q1, NET_Q2, NET_Q3, NET_Q4)),
         NET_Q1_tr = NET_Q1/networking_sum*10, 
         NET_Q2_tr = NET_Q2/networking_sum*10, 
         NET_Q3_tr = NET_Q3/networking_sum*10,
         NET_Q4_tr = NET_Q4/networking_sum*10) |> 
  mutate(NET_Q1_log = log10(NET_Q1_tr), 
         NET_Q2_log = log10(NET_Q2_tr), 
         NET_Q3_log = log10(NET_Q3_tr),
         NET_Q4_log = log10(NET_Q4_tr)) |> 
  mutate(effectuation_sum = sum(c(ME_Q1, ME_Q2, ME_Q3, ME_Q4)),
         ME_Q1_tr = ME_Q1/effectuation_sum*10, 
         ME_Q2_tr = ME_Q2/effectuation_sum*10, 
         ME_Q3_tr = ME_Q3/effectuation_sum*10,
         ME_Q4_tr = ME_Q4/effectuation_sum*10) |> 
  mutate(ME_Q1_log = log10(ME_Q1_tr), 
         ME_Q2_log = log10(ME_Q2_tr), 
         ME_Q3_log = log10(ME_Q3_tr),
         ME_Q4_log = log10(ME_Q4_tr)) |> 
  mutate(social_network_sum = sum(constraint, clustering, density),
         constraint_tr = constraint/social_network_sum,
         clustering_tr = clustering/social_network_sum,
         density_tr = density/social_network_sum) |> 
  mutate(constraint_log = log10(constraint_tr),
         density_log = log10(density_tr),
         clustering_log = sqrt(clustering_tr))

data_vivi_center_networking <- 
  center_colmeans(data_vivi_tr |> 
                    select(NET_Q1_log, 
                           NET_Q2_log, 
                           NET_Q3_log , 
                           NET_Q4_log)) 

data_vivi_autscale_networking <- 
  center_colstd.dev(data_vivi_center_networking)

data_vivi_center_effectuation <- 
  center_colmeans(data_vivi_tr |> 
                    select(ME_Q1_log, 
                           ME_Q2_log, 
                           ME_Q3_log , 
                           ME_Q4_log)) 

data_vivi_autscale_effectuation <- 
  center_colstd.dev(data_vivi_center_effectuation)

data_vivi_center_social_network <- 
  center_colmeans(data_vivi_tr |> 
                    select(constraint_log, 
                           density_log, 
                           clustering_log)) 

data_vivi_autscale_social_network <- 
  center_colstd.dev(data_vivi_center_social_network)

data_vivi_autscale_total <- 
  data_vivi_autscale_networking |> 
  bind_cols(data_vivi_center_effectuation, 
            data_vivi_autscale_social_network)

constraint_t <- 
  bestNormalize(data_vivi_autscale_total$constraint)$x.t |> 
  tibble() |> 
  rename("constraint_t" = 1) 

data_vivi_final <- 
  data_vivi_autscale_total |> 
  bind_cols(constraint_t)

```


```{r}
data_jrme_mod_5 <- 
  semTools::indProd(data_vivi_final,
                    var1 = c("NET_Q1_log", "NET_Q2_log", "NET_Q3_log", "NET_Q4_log"),
                    var2 = c("ME_Q1_log","ME_Q2_log", "ME_Q3_log", "ME_Q4_log"),
                    match = FALSE,
                    meanC = TRUE,
                    residualC = FALSE,
                    doubleMC = TRUE)
```

Model

```{r}
networking_model_mod_5 <- 
  "# measurement model
   networking_jrme =~ NET_Q1_log + NET_Q2_log + NET_Q3_log + NET_Q4_log
   effectuation <~ ME_Q1_log + ME_Q2_log + ME_Q3_log + ME_Q4_log
   net_structure =~ constraint
   # interaction term
   networkingeffectuation =~  NET_Q1_log.ME_Q1_log + NET_Q1_log.ME_Q2_log + NET_Q1_log.ME_Q3_log + NET_Q1_log.ME_Q4_log +
                              NET_Q2_log.ME_Q1_log + NET_Q2_log.ME_Q2_log + NET_Q2_log.ME_Q3_log + NET_Q2_log.ME_Q4_log +
                              NET_Q3_log.ME_Q1_log + NET_Q3_log.ME_Q2_log + NET_Q3_log.ME_Q3_log + NET_Q3_log.ME_Q4_log +
                              NET_Q4_log.ME_Q1_log + NET_Q4_log.ME_Q2_log + NET_Q4_log.ME_Q3_log + NET_Q4_log.ME_Q4_log
   # regressions
   net_structure ~ networking_jrme + networkingeffectuation
   # residual correlations"
```

Model fit 

```{r}
networking_fit_mod_5 <- 
  sem(model = networking_model_mod_5, 
      data = data_jrme_mod_5)
```

Table 

```{r}
parameterestimates(networking_fit_mod_5,
                   standardized = TRUE) |> 
  filter(op == "~") |> 
  mutate(stars = ifelse(pvalue < 0.001, "***",
                        ifelse(pvalue < 0.01, "**",
                               ifelse(pvalue < 0.05, "*", "")))) |> 
  select(LHS = lhs, RHS = rhs, Coefficient = est, 
         Z = z, "p-value" = pvalue, Sig. = stars) |> 
  stargazer(type = "text", title = "Regression Coefficients", 
            summary = FALSE, digits = 3, 
            digits.extra = 0, rownames = FALSE)
```

Checking distributions out

```{r}
data_jrme_mod_5 |> 
  rowwise() |> 
  mutate(networking = mean(NET_Q1_log, NET_Q2_log, NET_Q3_log, NET_Q4_log)) |> 
  ggplot(aes(x = networking)) +
  geom_histogram() 
```
Detecting anomalies

```{r}
data_jrme_mod_5_1 <- 
  data_jrme_mod_5 |> 
  rowwise() |> 
  mutate(networking = mean(NET_Q1_log, NET_Q2_log, NET_Q3_log, NET_Q4_log)) |> 
  anomalize(networking, method = "gesd") |> 
  dplyr::filter(anomaly != "Yes") |> 
  select(-anomaly) |> 
  anomalize(constraint_t, method = "gesd") |> 
  dplyr::filter(anomaly != "Yes")
```


```{r}
networking_hist <- 
  data_jrme_mod_5_1 |> 
  ggplot(aes(x = networking)) +
  geom_histogram(binwidth = 0.5)

constraint_hist <- 
  data_jrme_mod_5_1 |> 
  ggplot(aes(x = constraint_t)) +
  geom_histogram(binwidth = 0.5)

grid.arrange(networking_hist, constraint_hist)
```


```{r}
data_jrme_mod_5_1 |>
  select(networking, constraint_t) |> 
  correlate()

```

```{r}
summary(lm(constraint_t ~ networking, data = data_jrme_mod_5_1))
```

Next option is PLS-SEM and change constraint metric. 

```{r}
data_jrme_mod_5 |> 
  rowwise() |> 
  mutate(networking = mean(NET_Q1_log, NET_Q2_log, NET_Q3_log, NET_Q4_log)) |> 
  anomalize(networking, method = "gesd") |> 
  dplyr::filter(anomaly != "Yes") |> 
  ggplot(aes(x = networking, y = constraint)) +
  geom_point() +
  geom_smooth()
```
```{r}
constraint_hist_1 <- 
  data_jrme_mod_5 |> 
  rowwise() |> 
  mutate(networking = mean(NET_Q1_log, NET_Q2_log, NET_Q3_log, NET_Q4_log)) |> 
  anomalize(networking, method = "gesd") |> 
  dplyr::filter(anomaly != "Yes") |> 
  mutate(constraint_tr = 1/(constraint)) |> 
  ggplot(aes(x = constraint_st)) +
  geom_histogram()

constraint_hist_1
```

Normalization, standardization, and transformation

https://www.r-bloggers.com/2020/01/a-guide-to-data-transformation/


```{r}
data_jrme_mod_5_1 <- 
  data_jrme_mod_5 |> 
  bind_cols(df_egonet |> 
              select(constraint_nor)) |> 
  rowwise() |> 
  mutate(networking = mean(NET_Q1_log, NET_Q2_log, NET_Q3_log, NET_Q4_log)) |> 
  anomalize(networking, method = "gesd") |> 
  dplyr::filter(anomaly != "Yes")
```


```{r}
data_jrme_mod_5_1 |> 
  select(networking, constraint_nor, constraint, constra) |> 
  correlate()
```




But what I want to see, it's the relationship between networking and constraint

```{r}
data_jrme_mod_5 |> 
  rowwise |> 
  mutate()
```


# Try 4

```{r}
data_jrme_mod_4 <- 
  semTools::indProd(data_tidied_1,
                    var1 = c("NET_Q1_tr", "NET_Q2_tr", "NET_Q3_tr", "NET_Q4_tr"),
                    var2 = c("ME_Q1_tr","ME_Q2_tr", "ME_Q3_tr", "ME_Q4_tr"),
                    match = FALSE,
                    meanC = TRUE,
                    residualC = FALSE,
                    doubleMC = TRUE)
```

```{r}
data_jrme_mod_4 |>
  select(60:75) |> 
  names()
```


Model

```{r}
networking_model_mod_4 <- 
  "# measurement model
   networking_jrme =~ NET_Q1_tr + NET_Q2_tr + NET_Q3_tr + NET_Q4_tr
   effectuation <~ ME_Q1_tr + ME_Q2_tr + ME_Q3_tr + ME_Q4_tr
   net_structure =~ constraint
   # interaction term
   networkingeffectuation =~  NET_Q1_tr.ME_Q1_tr + NET_Q1_tr.ME_Q2_tr + NET_Q1_tr.ME_Q3_tr + NET_Q1_tr.ME_Q4_tr +
                              NET_Q2_tr.ME_Q1_tr + NET_Q2_tr.ME_Q2_tr + NET_Q2_tr.ME_Q3_tr + NET_Q2_tr.ME_Q4_tr +
                              NET_Q3_tr.ME_Q1_tr + NET_Q3_tr.ME_Q2_tr + NET_Q3_tr.ME_Q3_tr + NET_Q3_tr.ME_Q4_tr +
                              NET_Q4_tr.ME_Q1_tr + NET_Q4_tr.ME_Q2_tr + NET_Q4_tr.ME_Q3_tr + NET_Q4_tr.ME_Q4_tr
   # regressions
   net_structure ~ networking_jrme + networkingeffectuation
   # residual correlations"
```


Model fit 

```{r}
networking_fit_mod_4 <- 
  sem(model = networking_model_mod_4, 
      data = data_jrme_mod_4)
```

Table 

```{r}
parameterestimates(networking_fit_mod_4,
                   standardized = TRUE) |> 
  filter(op == "~") |> 
  mutate(stars = ifelse(pvalue < 0.001, "***",
                        ifelse(pvalue < 0.01, "**",
                               ifelse(pvalue < 0.05, "*", "")))) |> 
  select(LHS = lhs, RHS = rhs, Coefficient = est, 
         Z = z, "p-value" = pvalue, Sig. = stars) |> 
  stargazer(type = "text", title = "Regression Coefficients", 
            summary = FALSE, digits = 3, 
            digits.extra = 0, rownames = FALSE)
```

The model's outputs are poor. We need to improve the relationship between networking and net_structure. I want to see the correlations. 

```{r}
data_tidied_1 |> 
  rowwise() |> 
  mutate(networking_mean_raw = mean(c(NET_Q1, NET_Q2, NET_Q3, NET_Q4))) |> 
  select(networking_mean, networking_mean_raw, constraint, density, clustering) 
```

What if we remove items?. For example, items with 0 standard deviation?

```{r}
data_tidied_2 <- 
  data_tidied_1 |> 
  rowwise() |> 
  mutate(networking_sd = sd(c(NET_Q1, NET_Q2, NET_Q3, NET_Q4)),
         effectuation_sd = sd(c(ME_Q1, ME_Q2, ME_Q3, ME_Q4))) |> 
  filter(networking_sd == 0) |> 
  filter(effectuation_sd == 0)
```

```{r}
data_tidied_2 |> 
  rowwise() |> 
  mutate(networking_mean_raw = mean(c(NET_Q1, NET_Q2, NET_Q3, NET_Q4))) |> 
  select(networking_mean, networking_mean_raw, constraint, density, clustering) |> 
  correlate()
```

Checking the regression model 

```{r}
df_1 <- 
  data_tidied_1 |> 
  rowwise() |> 
  mutate(networking_mean_raw = mean(c(NET_Q1, NET_Q2, NET_Q3, NET_Q4))) |>
  select(networking_mean, constraint)

model_1 <- 
  linear_reg() |> 
  set_engine("lm") |> 
  fit(constraint ~ networking_mean, df_1)

model_2 <- lm(constraint ~ networking_mean, df_1)

get_regression_table(model_2)
```
Checking the model

```{r}
performance::check_model(model_2)
```
```{r}
df_1 |> 
  mutate(ET_Q1_sc_tr = autoTransform(NET_Q1),
         NET_Q2_sc_tr = autoTransform(NET_Q2),
         NET_Q3_sc_tr = autoTransform(NET_Q3),
         NET_Q4_sc_tr = autoTransform(NET_Q4)) |> 
  select(networking_mean, constraint) |>
  pivot_longer(cols = c(networking_mean, 
                        constraint), 
               names_to = "variable", 
               values_to =  "value") |> 
  ggplot(aes(x = variable, y = value)) +
  geom_boxplot() +
  facet_wrap(~ variable)

```

```{r}
data_tidied_1_csv <- read_csv(here("data", "jrme_data_all_1.csv"))


data_tidied_1_csv |> 
  mutate(NET_Q1_tr_sc = scale(NET_Q1_tr),
         NET_Q2_tr_sc = scale(NET_Q2_tr),
         NET_Q3_tr_sc = scale(NET_Q3_tr),
         NET_Q4_tr_sc = scale(NET_Q4_tr)) |> 
  rowwise() |> 
  mutate(networking_mean_tr_sc = mean(c(NET_Q1_tr_sc, 
                                        NET_Q2_tr_sc, 
                                        NET_Q3_tr_sc, 
                                        NET_Q4_tr_sc))) |>
  select(networking_mean_tr_sc, constraint) |> 
  pivot_longer(cols = c(networking_mean_tr_sc, 
                        constraint), 
               names_to = "variable", 
               values_to =  "value") |> 
  ggplot(aes(x = variable, y = value)) +
  geom_boxplot() +
  facet_wrap(~ variable)
```

```{r}
data_tidied_1_csv |> 
  mutate(NET_Q1_tr_sc = scale(NET_Q1_tr),
         NET_Q2_tr_sc = scale(NET_Q2_tr),
         NET_Q3_tr_sc = scale(NET_Q3_tr),
         NET_Q4_tr_sc = scale(NET_Q4_tr)) |> 
  rowwise() |> 
  mutate(networking_mean_tr_sc = mean(c(NET_Q1_tr_sc, 
                                        NET_Q2_tr_sc, 
                                        NET_Q3_tr_sc, 
                                        NET_Q4_tr_sc))) |>
  select(networking_mean_tr_sc, constraint) |> 
  ggplot(aes(x = networking_mean_tr_sc, y = constraint)) +
  geom_point() +
  geom_smooth()
```
remove outliers....in networking 

```{r}
data_tidied_2 <- 
  data_tidied_1_csv |> 
  mutate(NET_Q1_tr_sc = scale(NET_Q1_tr),
         NET_Q2_tr_sc = scale(NET_Q2_tr),
         NET_Q3_tr_sc = scale(NET_Q3_tr),
         NET_Q4_tr_sc = scale(NET_Q4_tr)) |> 
  rowwise() |> 
  mutate(networking_mean_tr_sc = mean(c(NET_Q1_tr_sc, 
                                        NET_Q2_tr_sc, 
                                        NET_Q3_tr_sc, 
                                        NET_Q4_tr_sc))) 

data_tidied_2 |> 
  anomalize(NET_Q1, method = "gesd") |> # just 4 and the rest no-one. 
  filter(anomaly == "No") |> 
  select(-NET_Q1_l1,NET_Q1_l2, -anomaly) |> 
  anomalize(NET_Q4, method = "gesd") |> 
  filter(anomaly == "No") |> 
  select(NET_Q4, anomaly) 
```

Remove extreme values 

http://qsel.columbia.edu/formhub.R/demo/RemoveOutliers.html

```{r}
data_tidied_2 |> 
  ggplot(aes(x = networking_mean_tr_sc)) +
  geom_histogram()
```
```{r}
data_tidied_2 |> 
  ggplot(aes(x = constraint)) +
  geom_histogram()
```
Scale and transform constraint????

# Try 3

```{r}
data_jrme_mod_3 <- 
  semTools::indProd(data_tidied_1,
                    var1 = c("NET_Q1_tr", "NET_Q2_tr", "NET_Q3_tr", "NET_Q4_tr"),
                    var2 = c("ME_Q2_tr", "ME_Q3_tr", "ME_Q4_tr"),
                    match = FALSE,
                    meanC = TRUE,
                    residualC = FALSE,
                    doubleMC = TRUE)
```

Model 

```{r}
networking_model_mod_3 <- 
  "# measurement model
   networking_jrme =~ NET_Q1_tr + NET_Q2_tr + NET_Q3_tr + NET_Q4_tr
   effectuation =~ ME_Q2_tr + ME_Q3_tr + ME_Q4_tr
   net_structure =~ constraint
   # interaction term
   networkingeffectuation =~ NET_Q1_tr.ME_Q2_tr + NET_Q1_tr.ME_Q3_tr + NET_Q1_tr.ME_Q4_tr +
                             NET_Q2_tr.ME_Q2_tr + NET_Q2_tr.ME_Q3_tr + NET_Q2_tr.ME_Q4_tr +
                             NET_Q3_tr.ME_Q2_tr + NET_Q3_tr.ME_Q3_tr + NET_Q3_tr.ME_Q4_tr +
                             NET_Q4_tr.ME_Q2_tr + NET_Q4_tr.ME_Q3_tr + NET_Q4_tr.ME_Q4_tr
   # regressions
   net_structure ~ networking_jrme + effectuation + networkingeffectuation
   # residual correlations"
```


Model fit 

```{r}
networking_fit_mod_3 <- 
  sem(model = networking_model_mod_3, 
      data = data_jrme_mod_3)
```

Table 

```{r}
parameterestimates(networking_fit_mod_3,
                   standardized = TRUE) |> 
  filter(op == "~") |> 
  mutate(stars = ifelse(pvalue < 0.001, "***",
                        ifelse(pvalue < 0.01, "**",
                               ifelse(pvalue < 0.05, "*", "")))) |> 
  select(LHS = lhs, RHS = rhs, Coefficient = est, 
         Z = z, "p-value" = pvalue, Sig. = stars) |> 
  stargazer(type = "text", title = "Regression Coefficients", 
            summary = FALSE, digits = 3, 
            digits.extra = 0, rownames = FALSE)
```


# Try 2

http://www.koreascience.or.kr/article/JAKO201919059190001.view

```{r}
data_jrme_mod <- 
  semTools::indProd(data_tidied_1,
                    var1 = c("NET_Q1", "NET_Q2", "NET_Q3", "NET_Q4"),
                    var2 = c("ME_Q2", "ME_Q3", "ME_Q4"),
                    match = FALSE,
                    meanC = TRUE,
                    residualC = FALSE,
                    doubleMC = TRUE)
```

New variables

```{r}
data_jrme_mod |> 
  select(48:59) |> 
  names()
```

Model 

```{r}
networking_model_mod <- 
  "# measurement model
   networking_jrme =~ NET_Q1 + NET_Q2 + NET_Q3 + NET_Q4
   effectuation =~ ME_Q2 + ME_Q3 + ME_Q4
   net_structure =~ constraint
   # interaction term
   networkingeffectuation =~ NET_Q1.ME_Q2 + NET_Q1.ME_Q3 + NET_Q1.ME_Q4 +
                             NET_Q2.ME_Q2 + NET_Q2.ME_Q3 + NET_Q2.ME_Q4 +
                             NET_Q3.ME_Q2 + NET_Q3.ME_Q3 + NET_Q3.ME_Q4 +
                             NET_Q4.ME_Q2 + NET_Q4.ME_Q3 + NET_Q4.ME_Q4
   # regressions
   net_structure ~ networking_jrme + effectuation + networkingeffectuation
   # residual correlations"
```

Model fit 

```{r}
networking_fit_mod <- 
  sem(model = networking_model_mod, 
      data = data_jrme_mod)
```


```{r}
summary(networking_fit_mod, standardized = TRUE)
```


```{r}
parameterestimates(networking_fit_mod, standardized = TRUE)
```
```{r}
parameterestimates(networking_fit_mod, standardized = TRUE) |> 
  filter(op == "~") |> 
  mutate(stars = ifelse(pvalue < 0.001, "***",
                        ifelse(pvalue < 0.01, "**",
                               ifelse(pvalue < 0.05, "*", "")))) |> 
  select(LHS = lhs, RHS = rhs, Coefficient = est, 
         Z = z, "p-value" = pvalue, Sig. = stars) |> 
  stargazer(type = "text", title = "Regression Coefficients", 
            summary = FALSE, digits = 3, 
            digits.extra = 0, rownames = FALSE)
```


# Try 1

## Moderating effect

Creating the interaction term between networking and effectuation

```{r}
data_jrme_modet <- 
  data_jrme |> 
  mutate(networking_x_effectuation = networking * modelo_efectual)
```

Parameters

```{r}
moderation_model <- "
  # regressions
  Net_Str ~ b1*networking
  Net_Str ~ b2*modelo_efectual
  Net_Str ~ b3*networking_x_effectuation
  
  modelo_efectual ~ modelo_efectual.mean*1
  
  modelo_efectual ~~ modelo_efectual.var*modelo_efectual
  
  SD.below := b1 + b3*(modelo_efectual.mean - sqrt(modelo_efectual))
  mean := b1 + b3*(modelo_efectual)
  SD.above := b1 + b3*(modelo_efectual.mean + sqrt(modelo_efectual))
  "


EffecModel_jrme <- "
                    
                    networking ~ modelo_efectual
                    Net_Str ~ networking
                    "
```


```{r}
sem1 <- 
  cfa(EffecModel_jrme, data = data_jrme_modet)
```

```{r}
summary(sem1, fit.measures=TRUE, standardized=T,rsquare=T)
```

